<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Experimento</title>
    <!-- Libs -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <!-- App CSS - Path confirmed to be correct as per instructions -->
    <link rel="stylesheet" href="/eai-agent/admin/experiments/static/experiment.css">
    <!-- Favicon -->
    <link rel="icon" href="{{BASE_API_URL}}/admin/experiments/favicon.ico" type="image/x-icon">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="d-flex justify-content-center align-items-center vh-100">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">Verificando autenticação...</p>
        </div>
    </div>

    <!-- Painel Principal (Refactored to fixed sidebar layout) -->
    <div id="experimentsPanel" class="d-none d-flex flex-column vh-100"> <!-- Main app container, fills screen height -->

        <!-- Global Header -->
        <header class="container-xl py-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <div>
                        <h1 class="h3 mb-0" id="experiment-title">Detalhes do Experimento</h1>
                        <small class="text-muted" id="experiment-info">Análise detalhada de experimento</small>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <a href="#" id="backToDatasetBtn" class="btn btn-outline-secondary d-none" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Voltar">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <button id="viewJsonBtn" class="btn btn-outline-info d-none" data-bs-toggle="modal" data-bs-target="#jsonModal" title="Ver JSON" data-bs-placement="bottom">
                        <i class="bi bi-code-square"></i>
                    </button>
                    <button id="downloadJsonBtn" class="btn btn-outline-success d-none" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Download JSON">
                        <i class="bi bi-download"></i>
                    </button>
                    <button id="downloadJsonLlmBtn" class="btn btn-outline-warning d-none" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Exportar LLM">
                        <i class="bi bi-robot"></i>
                    </button>
                    <button id="themeToggleBtn" class="btn btn-outline-secondary" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Tema">
                        <i class="bi bi-moon-fill" id="themeIcon"></i>
                    </button>
                    <button id="logoutBtn" class="btn btn-outline-danger" onclick="AuthCheck.logout()" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Sair">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main content area below header - this will be the flex container for sidebar and details -->
        <div class="main-app-content">

            <!-- Left Panel: Run List (Fixed Sidebar) -->
            <div id="run-list-panel">
                <div id="filterContainer" class="p-3 border-bottom"></div>
                <div class="list-header p-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Execuções (Runs)</h5>
                    <span id="run-count-badge" class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill"></span>
                </div>
                <!-- The run list is dynamically populated by JS. The HTML structure is prepared for a simplified ID display. -->
                <div id="run-list" class="list-group list-group-flush"></div>
            </div>

            <!-- Right Panel: Main Content (Scrollable) -->
            <div id="main-content-wrapper" class="flex-grow-1 overflow-y-auto">
                <div class="container-xl py-4"> <!-- Inner padding for right-side content -->

                    <div id="loadingIndicator" class="d-none text-center my-5">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>

                    <div id="alertArea" class="mb-3"></div>

                    <div id="welcome-screen" class="text-center text-muted p-5 border rounded bg-light">
                        <h3>Bem-vindo aos Detalhes do Experimento</h3>
                        <p class="mb-0">Navegue pelos datasets para visualizar experimentos específicos ou acesse diretamente via URL com parâmetro ?id=...</p>
                    </div>

                    <!-- Result container now sits cleanly within the main page container -->
                    <div id="resultContainer" class="d-none">
                        <!-- Metadata and Metrics Containers (now part of the scrollable main content) -->
                        <div id="metadataContainer" class="mb-4"></div>
                        <div id="summaryMetricsContainer" class="mb-4"></div>

                        <!-- Details Panel (now a standalone card-like component) -->
                        <div id="details-panel" class="card-component">
                            <div id="details-placeholder" class="d-flex h-100 align-items-center justify-content-center text-center text-muted p-4">
                                <div>
                                    <i class="bi bi-card-list" style="font-size: 3rem;"></i>
                                    <p class="mt-2">Selecione um run na lista à esquerda para ver os detalhes.</p>
                                </div>
                            </div>
                            <div id="details-content" class="d-none">
                                <h4 class="section-title">Mensagem do Usuário</h4>
                                <div id="user-message-container" class="alert alert-light"></div>

                                <h4 class="section-title mb-0">Comparação de Respostas</h4>
                                <!-- Removed toggle-diff-btn as requested -->
                                <div id="comparison-container" class="mt-3"></div>

                                <h4 class="section-title">Avaliações</h4>
                                <div id="evaluations-container"></div>

                                <div class="section-header">
                                    <h4 class="section-title">Cadeia de Pensamento (Reasoning)</h4>
                                    <!-- JS will inject tool call summary here -->
                                </div>
                                <div id="reasoning-timeline-container"></div>

                                <!-- Removed "Erros" section as requested -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualização do JSON -->
    <div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="jsonModalLabel">JSON Original do Experimento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="json-content" id="jsonContent"><!-- Conteúdo do JSON será inserido aqui --></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Download JSON for LLM -->
    <div class="modal fade" id="downloadJsonLlmModal" tabindex="-1" aria-labelledby="downloadJsonLlmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadJsonLlmModalLabel">Download JSON for LLM</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="numberOfExperimentsLlm" class="form-label">Número de experimentos (opcional)</label>
                        <input type="number" class="form-control" id="numberOfExperimentsLlm" min="1" placeholder="Deixe em branco para baixar todos">
                        <div class="form-text">Realiza o download de uma versão mais limpa dos dados do experimento. Se não especificar um número, todos os experimentos serão baixados. Se especificar, será feita uma seleção aleatória.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Filtros de Conteúdo</label>
                        <div class="form-text mb-3">Selecione quais tipos de dados incluir no download</div>
                        
                        <!-- Campos Básicos -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Campos Básicos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filter_message_id" checked>
                                            <label class="form-check-label" for="filter_message_id">ID da Mensagem</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filter_menssagem" checked>
                                            <label class="form-check-label" for="filter_menssagem">Mensagem do Usuário</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filter_golden_answer" checked>
                                            <label class="form-check-label" for="filter_golden_answer">Resposta Esperada</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filter_model_response" checked>
                                            <label class="form-check-label" for="filter_model_response">Resposta do Modelo</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reasoning Messages -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="filter_reasoning_messages" checked>
                                    <label class="form-check-label fw-bold" for="filter_reasoning_messages">Mensagens de Raciocínio (reasoning_message)</label>
                                </div>
                            </div>
                        </div>

                        <!-- Tool Call Messages -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="filter_tool_call_messages" checked>
                                    <label class="form-check-label fw-bold" for="filter_tool_call_messages">Chamadas de Ferramentas (tool_call_message)</label>
                                </div>
                            </div>
                            <div class="card-body" id="tool_call_options" style="display: none;">
                                <div class="form-text mb-2">Selecione quais ferramentas incluir:</div>
                                <div id="tool_call_tools_list">
                                    <!-- Será populado dinamicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Tool Return Messages -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="filter_tool_return_messages" checked>
                                    <label class="form-check-label fw-bold" for="filter_tool_return_messages">Retornos de Ferramentas (tool_return_message)</label>
                                </div>
                            </div>
                            <div class="card-body" id="tool_return_options" style="display: none;">
                                <div class="form-text mb-2">Selecione quais ferramentas incluir:</div>
                                <div id="tool_return_tools_list" class="mb-3">
                                    <!-- Será populado dinamicamente -->
                                </div>
                                
                                <div class="form-text mb-2">Selecione quais conteúdos incluir:</div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input tool-return-content" type="checkbox" id="content_text" checked>
                                            <label class="form-check-label" for="content_text">Texto de Resposta</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input tool-return-content" type="checkbox" id="content_sources" checked>
                                            <label class="form-check-label" for="content_sources">Fontes</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input tool-return-content" type="checkbox" id="content_web_search_queries" checked>
                                            <label class="form-check-label" for="content_web_search_queries">Consultas Web</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Metrics -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="filter_metrics" checked>
                                    <label class="form-check-label fw-bold" for="filter_metrics">Métricas de Avaliação</label>
                                </div>
                            </div>
                            <div class="card-body" id="metrics_options" style="display: none;">
                                <div class="form-text mb-2">Selecione quais métricas incluir:</div>
                                <div id="metrics_list">
                                    <!-- Será populado dinamicamente -->
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllFiltersBtn">Selecionar Todos</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllFiltersBtn">Limpar Seleção</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmDownloadJsonLlm">
                        <i class="bi bi-download me-1"></i>Baixar JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração global da API (unchanged)
        window.API_BASE_URL_OVERRIDE = '{{BASE_API_URL}}';
        
        // Injeta IDs do backend se disponíveis
        window.DATASET_ID = '{{DATASET_ID}}';
        window.EXPERIMENT_ID = '{{EXPERIMENT_ID}}';
        
        // Inicializar tooltips do Bootstrap com configurações otimizadas
        document.addEventListener('DOMContentLoaded', function() {
            // Incluir tanto elementos com data-bs-toggle="tooltip" quanto elementos com apenas title
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]:not([data-bs-toggle="modal"])'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    delay: { show: 300, hide: 100 },
                    animation: true,
                    trigger: 'hover focus'
                });
            });
            
            // Tratamento especial para o botão Ver JSON que tem modal
            var jsonBtn = document.getElementById('viewJsonBtn');
            if (jsonBtn) {
                new bootstrap.Tooltip(jsonBtn, {
                    delay: { show: 300, hide: 100 },
                    animation: true,
                    trigger: 'hover focus',
                    placement: 'bottom'
                });
            }
        });
    </script>
    <!-- Auth Check deve ser carregado PRIMEIRO -->
    <script src="/eai-agent/admin/experiments/static/auth-check.js"></script>
    <!-- App JS - Path confirmed to be correct as per instructions -->
    <script src="/eai-agent/admin/experiments/static/experiment.js"></script>
</body>
</html>